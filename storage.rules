rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    function isSignedIn() {
      return request.auth != null;
    }

    function userData() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data;
    }

    function userRole() {
      return userData().role;
    }

    function userSchoolId() {
      return userData().schoolId;
    }

    function isAdmin() {
      return isSignedIn()
        && (userRole() == "admin" || userData().roles.admin == true);
    }

    function isJudge() {
      return isSignedIn()
        && (userRole() == "judge" || userData().roles.judge == true);
    }

    function isDirector() {
      return isSignedIn()
        && (userRole() == "director" || userData().roles.director == true);
    }

    function isDirectorForSchool(schoolId) {
      return isDirector() && userSchoolId() == schoolId;
    }

    function submissionDoc(submissionId) {
      return firestore.get(
        /databases/(default)/documents/submissions/$(submissionId)
      ).data;
    }

    match /audio/{judgeUid}/{submissionId}/{fileName} {
      allow read: if isAdmin()
        || (isJudge() && request.auth.uid == judgeUid)
        || (isDirectorForSchool(submissionDoc(submissionId).schoolId)
          && submissionDoc(submissionId).status == "released");

      allow write: if isAdmin()
        || (isJudge() && request.auth.uid == judgeUid);
    }

    match /director_cards/{uid}/{fileName} {
      allow read: if isAdmin()
        || (isDirector() && request.auth.uid == uid);
      allow write: if isAdmin()
        || (isDirector() && request.auth.uid == uid);
    }

    match /{allPaths=**} {
      allow read, write: if isAdmin();
    }
  }
}

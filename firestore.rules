rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function hasEmailAuth() {
      return isSignedIn() && request.auth.token.email is string;
    }

    function isDirectorOnlyRoles(roles) {
      return roles is map
        && roles.director == true
        && (roles.admin == false || !("admin" in roles))
        && (roles.judge == false || !("judge" in roles));
    }

    function userData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function userRole() {
      return userData().role;
    }

    function userSchoolId() {
      return userData().schoolId;
    }

    function isAdmin() {
      return isSignedIn()
        && (userRole() == "admin" || userData().roles.admin == true);
    }

    function isJudge() {
      return isSignedIn()
        && (userRole() == "judge" || userData().roles.judge == true);
    }

    function isDirector() {
      return isSignedIn()
        && (userRole() == "director" || userData().roles.director == true);
    }

    function isDirectorForSchool(schoolId) {
      return isDirector() && userSchoolId() == schoolId;
    }

    function isActiveEvent(eventId) {
      return get(/databases/$(database)/documents/events/$(eventId)).data.isActive == true;
    }

    function schoolExists(schoolId) {
      return exists(/databases/$(database)/documents/schools/$(schoolId));
    }

    function schoolEnsembleExists(schoolId, ensembleId) {
      return exists(/databases/$(database)/documents/schools/$(schoolId)/ensembles/$(ensembleId));
    }

    function isJudgePosition(position) {
      return position == "stage1"
        || position == "stage2"
        || position == "stage3"
        || position == "sight";
    }

    function isValidSubmissionFormType(data) {
      return (
          data.judgePosition == "sight"
          && data.formType == "sight"
        ) || (
          (data.judgePosition == "stage1"
            || data.judgePosition == "stage2"
            || data.judgePosition == "stage3")
          && data.formType == "stage"
        );
    }

    function submissionIdMatchesData(data, submissionId) {
      return data.eventId is string
        && data.ensembleId is string
        && data.judgePosition is string
        && submissionId == data.eventId + "_" + data.ensembleId + "_" + data.judgePosition;
    }

    function isAssignedJudgeForPosition(data) {
      let assignments = get(
        /databases/$(database)/documents/events/$(data.eventId)/assignments/positions
      ).data;
      return (
          data.judgePosition == "stage1"
          && assignments.stage1Uid == request.auth.uid
        ) || (
          data.judgePosition == "stage2"
          && assignments.stage2Uid == request.auth.uid
        ) || (
          data.judgePosition == "stage3"
          && assignments.stage3Uid == request.auth.uid
        ) || (
          data.judgePosition == "sight"
          && assignments.sightUid == request.auth.uid
        );
    }

    function isValidJudgeRatingForTotal(total, rating) {
      return (
          total >= 7 && total <= 10 && rating == 1
        ) || (
          total >= 11 && total <= 17 && rating == 2
        ) || (
          total >= 18 && total <= 24 && rating == 3
        ) || (
          total >= 25 && total <= 31 && rating == 4
        ) || (
          total >= 32 && total <= 35 && rating == 5
        );
    }

    function hasValidSubmissionEnvelope(data, submissionId) {
      return submissionIdMatchesData(data, submissionId)
        && isJudgePosition(data.judgePosition)
        && isValidSubmissionFormType(data)
        && data.judgeUid == request.auth.uid
        && data.audioUrl is string
        && data.captions is map
        && data.captionScoreTotal is number
        && data.captionScoreTotal >= 7
        && data.captionScoreTotal <= 35
        && data.computedFinalRatingJudge is number
        && isValidJudgeRatingForTotal(data.captionScoreTotal, data.computedFinalRatingJudge)
        && isActiveEvent(data.eventId)
        && isAssignedJudgeForPosition(data);
    }

    match /users/{userId} {
      allow read: if isAdmin()
        || request.auth.uid == userId
        || (isDirector()
          && resource.data.schoolId == userSchoolId()
          && (
            resource.data.role == "director"
            || resource.data.roles.director == true
          ));
      allow create: if isAdmin()
        || (request.auth.uid == userId
          && hasEmailAuth()
          && request.resource.data.role == "director"
          && request.resource.data.keys().hasOnly([
            "role",
            "roles",
            "schoolId",
            "email",
            "displayName",
            "nafmeMembershipNumber",
            "nafmeMembershipExp",
            "nafmeCardImageUrl",
            "nafmeCardImagePath",
            "createdAt",
            "updatedAt"
          ])
          && request.resource.data.email == request.auth.token.email
          && isDirectorOnlyRoles(request.resource.data.roles)
          && request.resource.data.schoolId is string
          && exists(/databases/$(database)/documents/schools/$(request.resource.data.schoolId)));
      allow update: if isAdmin()
        || (request.auth.uid == userId
          && isDirector()
          && hasEmailAuth()
          && request.resource.data.email == resource.data.email
          && request.resource.data.role == resource.data.role
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            "schoolId",
            "updatedAt",
            "displayName",
            "nafmeMembershipNumber",
            "nafmeMembershipExp",
            "nafmeCardImageUrl",
            "nafmeCardImagePath",
            "roles"
          ])
          && (
            request.resource.data.roles == resource.data.roles
            || (resource.data.roles == null
              && isDirectorOnlyRoles(request.resource.data.roles))
          )
          && (
            request.resource.data.schoolId == resource.data.schoolId
            || (resource.data.schoolId == null
              && request.resource.data.schoolId is string
              && exists(/databases/$(database)/documents/schools/$(request.resource.data.schoolId)))
          ));
      allow delete: if isAdmin();
    }

    match /schools/{schoolId} {
      allow read: if true;
      allow write: if isAdmin();

      match /ensembles/{ensembleId} {
        allow read: if isAdmin()
          || isJudge()
          || (isDirector() && userSchoolId() == schoolId);
        allow create, update, delete: if isAdmin()
          || (isDirector() && userSchoolId() == schoolId);
      }
    }

    match /ensembles/{ensembleId} {
      allow read: if isAdmin()
        || isDirectorForSchool(resource.data.schoolId);
      allow create: if isAdmin()
        || isDirectorForSchool(request.resource.data.schoolId);
      allow update: if isAdmin()
        || (isDirectorForSchool(resource.data.schoolId)
          && request.resource.data.schoolId == resource.data.schoolId);
      allow delete: if isAdmin();
    }

    match /events/{eventId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();

      match /schedule/{entryId} {
        allow read: if (isAdmin() || isJudge()) && isActiveEvent(eventId);
        allow create, update: if isAdmin()
          && request.resource.data.performanceAt is timestamp
          && (!("holdingAt" in request.resource.data)
            || request.resource.data.holdingAt == null
            || request.resource.data.holdingAt is timestamp)
          && (!("warmupAt" in request.resource.data)
            || request.resource.data.warmupAt == null
            || request.resource.data.warmupAt is timestamp)
          && (request.resource.data.sightReadingAt == null
            || request.resource.data.sightReadingAt is timestamp)
          && (!("sortOrder" in request.resource.data) || request.resource.data.sortOrder is number)
          && request.resource.data.schoolId is string
          && request.resource.data.ensembleId is string
          && schoolExists(request.resource.data.schoolId)
          && schoolEnsembleExists(
            request.resource.data.schoolId,
            request.resource.data.ensembleId
          );
        allow delete: if isAdmin();
      }

      match /publishedSchedule/{rowId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
      }

      match /entries/{ensembleId} {
        allow read: if isAdmin()
          || (isDirector() && (resource == null || resource.data.schoolId == userSchoolId()))
          || (isJudge() && isActiveEvent(eventId));
        allow create, update: if isAdmin()
          || (isDirector()
            && request.resource.data.schoolId == userSchoolId()
            && request.resource.data.eventId == eventId
            && request.resource.data.ensembleId == ensembleId);
      }

      match /assignments/{assignmentId} {
        allow read: if isAdmin() || isJudge();
        allow write: if isAdmin();
      }
    }

    match /mpaRepertoire/{pieceId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /submissions/{submissionId} {
      allow read: if isAdmin()
        || (isJudge()
          && (resource == null || resource.data.judgeUid == request.auth.uid))
        || (resource != null
          && isDirectorForSchool(resource.data.schoolId)
          && resource.data.status == "released");

      allow create: if isJudge()
        && hasValidSubmissionEnvelope(request.resource.data, submissionId)
        && request.resource.data.status == "submitted"
        && request.resource.data.locked == true;

      allow update: if isAdmin()
        || (isJudge()
          && hasValidSubmissionEnvelope(request.resource.data, submissionId)
          && resource.data.judgeUid == request.auth.uid
          && resource.data.locked == false
          && resource.data.status == "submitted"
          && request.resource.data.locked == resource.data.locked
          && request.resource.data.judgeUid == resource.data.judgeUid
          && request.resource.data.eventId == resource.data.eventId
          && request.resource.data.ensembleId == resource.data.ensembleId
          && request.resource.data.judgePosition == resource.data.judgePosition
          && request.resource.data.formType == resource.data.formType
          && request.resource.data.status == resource.data.status);

      allow delete: if isAdmin();
    }

    match /packets/{packetId} {
      allow read: if isAdmin()
        || (isJudge() && (resource == null || resource.data.createdByJudgeUid == request.auth.uid))
        || (resource != null
          && isDirectorForSchool(resource.data.schoolId)
          && resource.data.status == "released");

      allow create: if isJudge()
        && request.resource.data.createdByJudgeUid == request.auth.uid
        && request.resource.data.status == "draft"
        && request.resource.data.locked == false;

      allow update: if isAdmin()
        || (isJudge()
          && resource.data.createdByJudgeUid == request.auth.uid
          && resource.data.locked == false
          && request.resource.data.locked == resource.data.locked
          && request.resource.data.status == resource.data.status);

      allow delete: if isAdmin();

      match /sessions/{sessionId} {
        allow read: if isAdmin()
          || (isJudge()
            && get(/databases/$(database)/documents/packets/$(packetId)).data.createdByJudgeUid == request.auth.uid)
          || (isDirectorForSchool(get(/databases/$(database)/documents/packets/$(packetId)).data.schoolId)
            && get(/databases/$(database)/documents/packets/$(packetId)).data.status == "released");
        allow create, update: if isJudge()
          && get(/databases/$(database)/documents/packets/$(packetId)).data.createdByJudgeUid == request.auth.uid
          && get(/databases/$(database)/documents/packets/$(packetId)).data.locked == false;
        allow delete: if isAdmin();
      }

      match /audit/{auditId} {
        allow read: if isAdmin();
        allow create, update, delete: if false;
      }
    }

    match /rateLimits/{docId} {
      allow read, write: if false;
    }

    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
